<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>‚ú® Magical Math Coloring ‚ú®</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Baloo 2', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            touch-action: pan-y;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .sparkle {
            position: fixed;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            animation: twinkle 2s infinite;
            z-index: 1;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Fredoka', sans-serif;
            font-size: 3em;
            color: white;
            text-shadow:
                0 4px 8px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.3em;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .game-container {
            background: white;
            border-radius: 30px;
            padding: 30px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 8px rgba(255, 255, 255, 0.2);
            animation: popIn 0.6s ease-out 0.3s both;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .level-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .level-btn {
            padding: 15px 30px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            touch-action: manipulation;
        }

        .level-btn.puppies {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            color: #d63031;
        }

        .level-btn.kitties {
            background: linear-gradient(135deg, #ff9ff3, #feca57);
            color: #ee5a6f;
        }

        .level-btn.unicorns {
            background: linear-gradient(135deg, #a29bfe, #fd79a8);
            color: white;
        }

        .level-btn.frogs {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
        }

        .level-btn.elephants {
            background: linear-gradient(135deg, #b2bec3, #636e72);
            color: white;
        }

        .level-btn.turtles {
            background: linear-gradient(135deg, #6ab04c, #badc58);
            color: #2d3436;
        }

        .level-btn.butterflies {
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
            color: white;
        }

        .level-btn:active {
            transform: scale(0.95);
        }

        .level-btn.active {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .lesson-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
            border-radius: 15px;
        }

        .lesson-info h3 {
            font-family: 'Fredoka', sans-serif;
            color: #2d3436;
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .lesson-info p {
            color: #636e72;
            font-size: 1em;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
            border-radius: 20px;
        }

        .color-option {
            text-align: center;
            animation: bounceIn 0.5s ease-out both;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .color-option:nth-child(1) { animation-delay: 0.1s; }
        .color-option:nth-child(2) { animation-delay: 0.15s; }
        .color-option:nth-child(3) { animation-delay: 0.2s; }
        .color-option:nth-child(4) { animation-delay: 0.25s; }
        .color-option:nth-child(5) { animation-delay: 0.3s; }
        .color-option:nth-child(6) { animation-delay: 0.35s; }
        .color-option:nth-child(7) { animation-delay: 0.4s; }
        .color-option:nth-child(8) { animation-delay: 0.45s; }

        .math-problem {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 8px;
            min-height: 35px;
        }

        .color-btn {
            width: 60px;
            height: 60px;
            border: 4px solid white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: inline-block;
            touch-action: manipulation;
        }

        .color-btn:active {
            transform: scale(0.9);
        }

        .color-btn.selected {
            border-color: #ffd700;
            border-width: 5px;
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .canvas-container {
            position: relative;
            margin: 25px auto;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #coloringCanvas {
            width: 100%;
            height: auto;
            border-radius: 15px;
            cursor: pointer;
            touch-action: none;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 15px 30px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            touch-action: manipulation;
        }

        .control-btn.reset {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
        }

        .control-btn.new {
            background: linear-gradient(135deg, #48dbfb, #0abde3);
            color: white;
        }

        .control-btn.next {
            background: linear-gradient(135deg, #5f27cd, #341f97);
            color: white;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 50px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            text-align: center;
            opacity: 0;
            pointer-events: none;
        }

        .celebration.show {
            animation: celebrate 0.6s ease-out forwards;
            pointer-events: auto;
        }

        @keyframes celebrate {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .celebration h2 {
            font-family: 'Fredoka', sans-serif;
            font-size: 3em;
            color: #a29bfe;
            margin-bottom: 20px;
        }

        .celebration p {
            font-size: 1.5em;
            color: #636e72;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 999;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .subtitle {
                font-size: 1em;
            }

            .game-container {
                padding: 20px;
            }

            .color-btn {
                width: 50px;
                height: 50px;
            }

            .math-problem {
                font-size: 1em;
            }
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #a29bfe, #fd79a8);
            transition: width 0.5s ease;
            border-radius: 15px;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
<a href="../" id="home-btn" style="position:fixed;top:12px;left:12px;z-index:9999;background:rgba(0,0,0,0.6);color:white;text-decoration:none;padding:8px 14px;border-radius:20px;font-family:'Comic Sans MS',cursive;font-size:16px;touch-action:manipulation;min-width:44px;min-height:44px;display:flex;align-items:center;gap:6px;box-sizing:border-box;">&#x1F3E0; Home</a>
    <!-- Sparkles -->
    <script>
        for (let i = 0; i < 30; i++) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.left = Math.random() * 100 + '%';
            sparkle.style.top = Math.random() * 100 + '%';
            sparkle.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(sparkle);
        }
    </script>

    <div class="container">
        <header>
            <h1>‚ú® Magical Math Coloring ‚ú®</h1>
            <p class="subtitle">Master 2nd Grade Math Skills!</p>
        </header>

        <div class="game-container">
            <div class="lesson-info">
                <h3 id="lessonTitle">Lesson 1: Addition Fluency</h3>
                <p id="lessonDescription">Practice adding numbers within 20</p>
            </div>

            <div class="level-selector">
                <button class="level-btn puppies active" data-level="puppies" onclick="selectLevel('puppies', this)">üê∂ Puppies</button>
                <button class="level-btn kitties" data-level="kitties" onclick="selectLevel('kitties', this)">üê± Kitties</button>
                <button class="level-btn unicorns" data-level="unicorns" onclick="selectLevel('unicorns', this)">ü¶Ñ Unicorns</button>
                <button class="level-btn frogs" data-level="frogs" onclick="selectLevel('frogs', this)">üê∏ Frogs</button>
                <button class="level-btn elephants" data-level="elephants" onclick="selectLevel('elephants', this)">üêò Elephants</button>
                <button class="level-btn turtles" data-level="turtles" onclick="selectLevel('turtles', this)">üê¢ Turtles</button>
                <button class="level-btn butterflies" data-level="butterflies" onclick="selectLevel('butterflies', this)">ü¶ã Butterflies</button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="color-palette" id="colorPalette"></div>

            <div class="canvas-container">
                <canvas id="coloringCanvas" width="600" height="600"></canvas>
            </div>

            <div class="controls">
                <button class="control-btn reset" onclick="resetCanvas()">
                    üîÑ Start Over
                </button>
                <button class="control-btn new" onclick="newPicture()">
                    ‚ú® New Picture
                </button>
                <button class="control-btn next" onclick="nextLesson()">
                    ‚û°Ô∏è Next Lesson
                </button>
            </div>
        </div>
    </div>

    <div class="celebration" id="celebration">
        <h2>üéâ Amazing Work! üéâ</h2>
        <p>You're a math superstar!</p>
        <button class="control-btn next" onclick="nextLesson(); hideCelebration();" style="margin-top:20px; pointer-events:auto;">‚û°Ô∏è Next Lesson</button>
    </div>

    <script>
        let currentLevel = 'puppies';
        let selectedColor = null;
        let coloredSections = new Set();
        let currentLesson = 0;
        let answerMap = {};  // original answer ‚Üí shuffled answer (randomised each round)

        const canvas = document.getElementById('coloringCanvas');
        const ctx = canvas.getContext('2d');

        // 25 Lessons covering 2nd grade curriculum
        const lessons = [
            {
                title: "Lesson 1: Addition Fluency",
                description: "Practice adding numbers within 20",
                problems: {
                    6: ['3 + 3', '4 + 2', '9 - 3', '2 + 4'],
                    7: ['4 + 3', '5 + 2', '10 - 3', '3 + 4'],
                    8: ['4 + 4', '5 + 3', '11 - 3', '6 + 2'],
                    9: ['5 + 4', '6 + 3', '12 - 3', '7 + 2'],
                    10: ['6 + 4', '5 + 5', '13 - 3', '7 + 3'],
                    12: ['6 + 6', '7 + 5', '15 - 3', '8 + 4'],
                    14: ['7 + 7', '8 + 6', '17 - 3', '9 + 5'],
                    15: ['8 + 7', '9 + 6', '18 - 3', '10 + 5']
                }
            },
            {
                title: "Lesson 2: Missing Addends",
                description: "Find the unknown number (algebraic thinking!)",
                problems: {
                    3: ['5 + ? = 8', '9 - 6 = ?', '? + 1 = 4', '10 - 7 = ?'],
                    4: ['6 + ? = 10', '11 - 7 = ?', '? + 2 = 6', '12 - 8 = ?'],
                    5: ['7 + ? = 12', '13 - 8 = ?', '? + 3 = 8', '14 - 9 = ?'],
                    6: ['8 + ? = 14', '15 - 9 = ?', '? + 4 = 10', '13 - 7 = ?'],
                    7: ['9 + ? = 16', '16 - 9 = ?', '? + 5 = 12', '14 - 7 = ?'],
                    8: ['10 + ? = 18', '17 - 9 = ?', '? + 6 = 14', '15 - 7 = ?'],
                    9: ['11 + ? = 20', '18 - 9 = ?', '? + 7 = 16', '16 - 7 = ?'],
                    10: ['5 + ? = 15', '20 - 10 = ?', '? + 8 = 18', '17 - 7 = ?']
                }
            },
            {
                title: "Lesson 3: Subtraction Fluency",
                description: "Practice subtracting within 20",
                problems: {
                    2: ['5 - 3', '8 - 6', '11 - 9', '10 - 8'],
                    3: ['7 - 4', '9 - 6', '12 - 9', '11 - 8'],
                    4: ['9 - 5', '10 - 6', '13 - 9', '12 - 8'],
                    5: ['11 - 6', '12 - 7', '14 - 9', '13 - 8'],
                    6: ['13 - 7', '14 - 8', '15 - 9', '16 - 10'],
                    7: ['15 - 8', '16 - 9', '17 - 10', '14 - 7'],
                    8: ['17 - 9', '18 - 10', '16 - 8', '15 - 7'],
                    9: ['18 - 9', '19 - 10', '17 - 8', '16 - 7']
                }
            },
            {
                title: "Lesson 4: Introduction to Multiplication",
                description: "Equal groups (2s, 5s, 10s)",
                problems: {
                    4: ['2 √ó 2', '2 + 2', '4 groups of 1'],
                    6: ['2 √ó 3', '3 + 3', '2 groups of 3'],
                    8: ['2 √ó 4', '4 + 4', '2 groups of 4'],
                    10: ['2 √ó 5', '5 + 5', '2 groups of 5'],
                    12: ['2 √ó 6', '6 + 6', '2 groups of 6'],
                    14: ['2 √ó 7', '7 + 7', '2 groups of 7'],
                    15: ['3 √ó 5', '5 + 5 + 5', '3 groups of 5'],
                    20: ['2 √ó 10', '10 + 10', '4 √ó 5']
                }
            },
            {
                title: "Lesson 5: Skip Counting by 5s",
                description: "Count by 5s to build multiplication",
                problems: {
                    5: ['5 √ó 1', 'Count: 5', '10 - 5'],
                    10: ['5 √ó 2', 'Count: 5, 10', '15 - 5'],
                    15: ['5 √ó 3', 'Count: 5, 10, 15', '20 - 5'],
                    20: ['5 √ó 4', 'Count: 5, 10, 15, 20', '25 - 5'],
                    25: ['5 √ó 5', '30 - 5', '20 + 5'],
                    30: ['5 √ó 6', '35 - 5', '25 + 5'],
                    35: ['5 √ó 7', '40 - 5', '30 + 5'],
                    40: ['5 √ó 8', '45 - 5', '35 + 5']
                }
            },
            {
                title: "Lesson 6: Even and Odd Numbers",
                description: "Identify even numbers (pairs)",
                problems: {
                    2: ['1 + 1', 'Even!', '4 - 2'],
                    4: ['2 + 2', 'Even!', '6 - 2'],
                    6: ['3 + 3', 'Even!', '8 - 2'],
                    8: ['4 + 4', 'Even!', '10 - 2'],
                    10: ['5 + 5', 'Even!', '12 - 2'],
                    12: ['6 + 6', 'Even!', '14 - 2'],
                    14: ['7 + 7', 'Even!', '16 - 2'],
                    16: ['8 + 8', 'Even!', '18 - 2']
                }
            },
            {
                title: "Lesson 7: Addition within 100",
                description: "Two-digit addition",
                problems: {
                    12: ['10 + 2', '6 + 6', '15 - 3'],
                    15: ['10 + 5', '8 + 7', '20 - 5'],
                    18: ['10 + 8', '9 + 9', '20 - 2'],
                    20: ['10 + 10', '15 + 5', '25 - 5'],
                    24: ['20 + 4', '12 + 12', '30 - 6'],
                    25: ['20 + 5', '15 + 10', '30 - 5'],
                    30: ['20 + 10', '15 + 15', '35 - 5'],
                    35: ['30 + 5', '20 + 15', '40 - 5']
                }
            },
            {
                title: "Lesson 8: Subtraction within 100",
                description: "Two-digit subtraction",
                problems: {
                    5: ['15 - 10', '20 - 15', '10 - 5'],
                    10: ['20 - 10', '25 - 15', '15 - 5'],
                    15: ['25 - 10', '30 - 15', '20 - 5'],
                    20: ['30 - 10', '35 - 15', '25 - 5'],
                    25: ['35 - 10', '40 - 15', '30 - 5'],
                    30: ['40 - 10', '45 - 15', '35 - 5'],
                    35: ['45 - 10', '50 - 15', '40 - 5'],
                    40: ['50 - 10', '55 - 15', '45 - 5']
                }
            },
            {
                title: "Lesson 9: Arrays (Multiplication Foundation)",
                description: "Count objects in rows and columns",
                problems: {
                    6: ['2 rows √ó 3', '3 + 3', '2 √ó 3'],
                    8: ['2 rows √ó 4', '4 + 4', '2 √ó 4'],
                    10: ['2 rows √ó 5', '5 + 5', '2 √ó 5'],
                    12: ['3 rows √ó 4', '4 + 4 + 4', '3 √ó 4'],
                    15: ['3 rows √ó 5', '5 + 5 + 5', '3 √ó 5'],
                    16: ['4 rows √ó 4', '4 + 4 + 4 + 4', '4 √ó 4'],
                    20: ['4 rows √ó 5', '5 + 5 + 5 + 5', '4 √ó 5'],
                    25: ['5 rows √ó 5', '5 + 5 + 5 + 5 + 5', '5 √ó 5']
                }
            },
            {
                title: "Lesson 10: Place Value Tens and Ones",
                description: "Understand tens and ones",
                problems: {
                    12: ['1 ten + 2 ones', '10 + 2', '6 + 6'],
                    15: ['1 ten + 5 ones', '10 + 5', '7 + 8'],
                    20: ['2 tens + 0 ones', '10 + 10', '15 + 5'],
                    24: ['2 tens + 4 ones', '20 + 4', '12 + 12'],
                    30: ['3 tens + 0 ones', '20 + 10', '25 + 5'],
                    35: ['3 tens + 5 ones', '30 + 5', '20 + 15'],
                    40: ['4 tens + 0 ones', '30 + 10', '35 + 5'],
                    45: ['4 tens + 5 ones', '40 + 5', '40 + 5']
                }
            },
            {
                title: "Lesson 11: Unknown Addend (Challenge)",
                description: "Solve for the mystery number!",
                problems: {
                    6: ['? + 8 = 14', '12 - ? = 6', '? + 4 = 10'],
                    7: ['? + 9 = 16', '14 - ? = 7', '? + 5 = 12'],
                    8: ['? + 7 = 15', '16 - ? = 8', '? + 6 = 14'],
                    9: ['? + 8 = 17', '18 - ? = 9', '? + 7 = 16'],
                    10: ['? + 10 = 20', '20 - ? = 10', '? + 5 = 15'],
                    12: ['? + 8 = 20', '24 - ? = 12', '? + 13 = 25'],
                    15: ['? + 15 = 30', '30 - ? = 15', '? + 10 = 25'],
                    20: ['? + 20 = 40', '40 - ? = 20', '? + 15 = 35']
                }
            },
            {
                title: "Lesson 12: Adding Three Numbers",
                description: "Add three addends",
                problems: {
                    6: ['2 + 2 + 2', '1 + 2 + 3', '3 + 1 + 2'],
                    9: ['3 + 3 + 3', '2 + 3 + 4', '4 + 2 + 3'],
                    12: ['4 + 4 + 4', '3 + 4 + 5', '5 + 3 + 4'],
                    15: ['5 + 5 + 5', '4 + 5 + 6', '6 + 4 + 5'],
                    18: ['6 + 6 + 6', '5 + 6 + 7', '7 + 5 + 6'],
                    21: ['7 + 7 + 7', '6 + 7 + 8', '8 + 6 + 7'],
                    24: ['8 + 8 + 8', '7 + 8 + 9', '9 + 7 + 8'],
                    27: ['9 + 9 + 9', '8 + 9 + 10', '10 + 8 + 9']
                }
            },
            {
                title: "Lesson 13: Comparing Numbers",
                description: "Greater than, less than, equal to",
                problems: {
                    5: ['3 < ?', '? > 2', '2 + 3'],
                    10: ['8 < ?', '? > 5', '5 + 5'],
                    15: ['12 < ?', '? > 10', '10 + 5'],
                    20: ['18 < ?', '? > 15', '10 + 10'],
                    25: ['23 < ?', '? > 20', '20 + 5'],
                    30: ['28 < ?', '? > 25', '25 + 5'],
                    35: ['33 < ?', '? > 30', '30 + 5'],
                    40: ['38 < ?', '? > 35', '35 + 5']
                }
            },
            {
                title: "Lesson 14: Skip Counting by 10s",
                description: "Count by tens",
                problems: {
                    10: ['10 √ó 1', 'Count: 10', '20 - 10'],
                    20: ['10 √ó 2', 'Count: 10, 20', '30 - 10'],
                    30: ['10 √ó 3', 'Count: 10, 20, 30', '40 - 10'],
                    40: ['10 √ó 4', '50 - 10', '30 + 10'],
                    50: ['10 √ó 5', '60 - 10', '40 + 10'],
                    60: ['10 √ó 6', '70 - 10', '50 + 10'],
                    70: ['10 √ó 7', '80 - 10', '60 + 10'],
                    80: ['10 √ó 8', '90 - 10', '70 + 10']
                }
            },
            {
                title: "Lesson 15: Doubles and Near Doubles",
                description: "Use doubles to add quickly",
                problems: {
                    6: ['3 + 3', 'Double 3', '4 - 1 + 3'],
                    8: ['4 + 4', 'Double 4', '5 - 1 + 4'],
                    10: ['5 + 5', 'Double 5', '6 - 1 + 5'],
                    12: ['6 + 6', 'Double 6', '7 - 1 + 6'],
                    14: ['7 + 7', 'Double 7', '8 - 1 + 7'],
                    16: ['8 + 8', 'Double 8', '9 - 1 + 8'],
                    18: ['9 + 9', 'Double 9', '10 - 1 + 9'],
                    20: ['10 + 10', 'Double 10', '11 - 1 + 10']
                }
            },
            {
                title: "Lesson 16: Making 10 Strategy",
                description: "Make 10 to add easier",
                problems: {
                    11: ['9 + 2', 'Make 10: 9 + 1 + 1', '10 + 1'],
                    12: ['9 + 3', 'Make 10: 9 + 1 + 2', '10 + 2'],
                    13: ['8 + 5', 'Make 10: 8 + 2 + 3', '10 + 3'],
                    14: ['8 + 6', 'Make 10: 8 + 2 + 4', '10 + 4'],
                    15: ['7 + 8', 'Make 10: 7 + 3 + 5', '10 + 5'],
                    16: ['7 + 9', 'Make 10: 7 + 3 + 6', '10 + 6'],
                    17: ['9 + 8', 'Make 10: 9 + 1 + 7', '10 + 7'],
                    18: ['9 + 9', 'Make 10: 9 + 1 + 8', '10 + 8']
                }
            },
            {
                title: "Lesson 17: Two-Step Word Problems",
                description: "Solve problems with 2 operations",
                problems: {
                    8: ['5 + 7 - 4', '10 - 2', '3 + 5'],
                    10: ['6 + 8 - 4', '12 - 2', '4 + 6'],
                    12: ['7 + 9 - 4', '14 - 2', '5 + 7'],
                    14: ['8 + 10 - 4', '16 - 2', '6 + 8'],
                    16: ['9 + 11 - 4', '18 - 2', '7 + 9'],
                    18: ['10 + 12 - 4', '20 - 2', '8 + 10'],
                    20: ['15 + 9 - 4', '22 - 2', '10 + 10'],
                    22: ['16 + 10 - 4', '24 - 2', '11 + 11']
                }
            },
            {
                title: "Lesson 18: Measurement & Addition",
                description: "Add lengths together",
                problems: {
                    12: ['5 cm + 7 cm', '6 in + 6 in', '8 + 4'],
                    15: ['8 cm + 7 cm', '10 in + 5 in', '9 + 6'],
                    18: ['10 cm + 8 cm', '12 in + 6 in', '9 + 9'],
                    20: ['12 cm + 8 cm', '15 in + 5 in', '10 + 10'],
                    24: ['14 cm + 10 cm', '18 in + 6 in', '12 + 12'],
                    25: ['15 cm + 10 cm', '20 in + 5 in', '20 + 5'],
                    30: ['20 cm + 10 cm', '25 in + 5 in', '25 + 5'],
                    35: ['25 cm + 10 cm', '30 in + 5 in', '30 + 5']
                }
            },
            {
                title: "Lesson 19: Number Patterns",
                description: "Find the pattern rule",
                problems: {
                    5: ['Pattern: +5', '0, 5, ?', '10 - 5'],
                    10: ['Pattern: +5', '5, 10, ?', '15 - 5'],
                    15: ['Pattern: +5', '10, 15, ?', '20 - 5'],
                    20: ['Pattern: +10', '10, 20, ?', '30 - 10'],
                    25: ['Pattern: +5', '20, 25, ?', '30 - 5'],
                    30: ['Pattern: +10', '20, 30, ?', '40 - 10'],
                    35: ['Pattern: +5', '30, 35, ?', '40 - 5'],
                    40: ['Pattern: +10', '30, 40, ?', '50 - 10']
                }
            },
            {
                title: "Lesson 20: Mental Math Strategies",
                description: "Add and subtract in your head!",
                problems: {
                    7: ['10 - 3', '4 + 3', '14 - 7'],
                    9: ['10 - 1', '4 + 5', '18 - 9'],
                    11: ['10 + 1', '5 + 6', '22 - 11'],
                    13: ['10 + 3', '6 + 7', '26 - 13'],
                    15: ['20 - 5', '8 + 7', '30 - 15'],
                    17: ['20 - 3', '9 + 8', '34 - 17'],
                    19: ['20 - 1', '10 + 9', '38 - 19'],
                    21: ['30 - 9', '11 + 10', '42 - 21']
                }
            },
            {
                title: "Lesson 21: Master Challenge!",
                description: "Mix of all skills learned",
                problems: {
                    8: ['? + 6 = 14', '2 √ó 4', '16 - 8'],
                    10: ['5 √ó 2', '? + 5 = 15', '20 - 10'],
                    12: ['3 √ó 4', '? + 7 = 19', '24 - 12'],
                    15: ['3 √ó 5', '? + 10 = 25', '30 - 15'],
                    18: ['2 √ó 9', '? + 8 = 26', '36 - 18'],
                    20: ['4 √ó 5', '? + 15 = 35', '40 - 20'],
                    24: ['6 √ó 4', '? + 12 = 36', '48 - 24'],
                    25: ['5 √ó 5', '? + 20 = 45', '50 - 25']
                }
            },
            {
                title: "Lesson 22: Fair Shares ‚Äî Halves",
                description: "Find half of a number",
                problems: {
                    2: ['Half of 4 = ?', '1/2 of 4 = ?', '4 shared equally = ? each', '2 + ? = 4'],
                    3: ['Half of 6 = ?', '1/2 of 6 = ?', '6 shared equally = ? each', '3 + ? = 6'],
                    4: ['Half of 8 = ?', '1/2 of 8 = ?', '8 shared equally = ? each', '4 + ? = 8'],
                    6: ['Half of 12 = ?', '1/2 of 12 = ?', '12 shared equally = ? each', '6 + ? = 12'],
                    8: ['Half of 16 = ?', '1/2 of 16 = ?', '16 shared equally = ? each', '8 + ? = 16']
                }
            },
            {
                title: "Lesson 23: Telling Time",
                description: "Read clocks to the hour and half-hour",
                problems: {
                    3: ['Hour hand ‚Üí 3, minute ‚Üí 12. What time?', 'Clock shows 3:00. What hour?', '1 + 2', '5 - 2'],
                    6: ['Hour hand ‚Üí 6, minute ‚Üí 12. What time?', 'Clock shows 6:00. What hour?', '3 + 3', '9 - 3'],
                    9: ['Hour hand ‚Üí 9, minute ‚Üí 12. What time?', 'Clock shows 9:00. What hour?', '4 + 5', '10 - 1'],
                    12: ['Hour hand ‚Üí 12, minute ‚Üí 12. What time?', 'Noon: both hands at 12. Hour?', '6 + 6', '10 + 2'],
                    30: ['Half past any hour = ? minutes', 'Minute hand at 6 = ? minutes past', '15 + 15', '20 + 10']
                }
            },
            {
                title: "Lesson 24: Money ‚Äî Counting Coins",
                description: "Count pennies, nickels, dimes, and quarters",
                problems: {
                    1: ['A penny = ? cent', 'The smallest coin = ?¬¢', '2 - 1', '1 + 0'],
                    5: ['A nickel = ? cents', '5¬¢ coin = how many cents?', '3 + 2', '10 - 5'],
                    10: ['A dime = ? cents', '2 nickels = ? cents', '5 + 5', '6 + 4'],
                    25: ['A quarter = ? cents', '5 nickels = ? cents', '10 + 10 + 5', '20 + 5']
                }
            },
            {
                title: "Lesson 25: Geometry ‚Äî Sides of Shapes",
                description: "Count the sides of 2D shapes",
                problems: {
                    3: ['A triangle has ? sides', 'A triangle has ? corners', '1 + 2', '5 - 2'],
                    4: ['A square has ? sides', 'A rectangle has ? sides', '2 + 2', '5 - 1'],
                    5: ['A pentagon has ? sides', '5-sided shape has ? angles', '2 + 3', '6 - 1'],
                    6: ['A hexagon has ? sides', '6-sided shape has ? corners', '3 + 3', '7 - 1'],
                    8: ['An octagon has ? sides', 'A STOP sign has ? sides', '4 + 4', '10 - 2']
                }
            }
        ];

        const colors = {
            1: '#FFEAA7',
            2: '#FF6B9D', 3: '#4ECDC4', 4: '#FFE66D', 5: '#A8E6CF',
            6: '#C7CEEA', 7: '#FFA07A', 8: '#DDA0DD', 9: '#87CEEB',
            10: '#FFB6C1', 11: '#98FB98', 12: '#98D8C8', 13: '#F0E68C',
            14: '#DDA0DD', 15: '#F7DC6F', 16: '#BB8FCE', 17: '#85C1E2',
            18: '#85C1E2', 19: '#F8B88B', 20: '#F8B88B', 21: '#FFD700',
            22: '#FF69B4', 24: '#87CEEB', 25: '#98FB98', 27: '#DDA0DD',
            30: '#A8D8EA', 35: '#FFA07A', 40: '#C7CEEA', 45: '#FF6B9D',
            50: '#A8E6CF', 60: '#4ECDC4', 70: '#FFE66D', 80: '#87CEEB'
        };

        const themes = {
            puppies: [
                { x: 150, y: 100, r: 80, answer: 6, type: 'circle' },    // left ear
                { x: 450, y: 100, r: 80, answer: 6, type: 'circle' },    // right ear
                { x: 300, y: 200, r: 120, answer: 8, type: 'circle' },   // head
                { x: 250, y: 200, r: 25, answer: 4, type: 'circle' },    // left eye
                { x: 350, y: 200, r: 25, answer: 4, type: 'circle' },    // right eye
                { x: 300, y: 250, r: 30, answer: 2, type: 'circle' },    // nose
                { x: 300, y: 380, r: 100, answer: 10, type: 'circle' },  // body
                { x: 245, y: 488, r: 40, answer: 5, type: 'circle' },    // left paw (~19px overlap with body)
                { x: 355, y: 488, r: 40, answer: 5, type: 'circle' },    // right paw (~19px overlap with body)
                { x: 395, y: 340, r: 35, answer: 3, type: 'circle' }     // tail (fixed: was 480,350 ‚Äî gap; now ~32px overlap)
            ],
            kitties: [
                { x: 200, y: 80, points: [[200,80],[180,140],[220,140]], answer: 7, type: 'triangle' },    // left ear
                { x: 400, y: 80, points: [[400,80],[380,140],[420,140]], answer: 7, type: 'triangle' },    // right ear
                { x: 300, y: 200, r: 120, answer: 9, type: 'circle' },   // head
                { x: 250, y: 190, r: 25, answer: 4, type: 'circle' },    // left eye
                { x: 350, y: 190, r: 25, answer: 4, type: 'circle' },    // right eye
                { x: 300, y: 240, r: 20, answer: 2, type: 'circle' },    // nose
                { x: 300, y: 380, r: 90, answer: 12, type: 'circle' },   // body
                { x: 250, y: 465, r: 35, answer: 6, type: 'circle' },    // left paw (fixed: was 230,520 ‚Äî gap; now ~26px overlap)
                { x: 350, y: 465, r: 35, answer: 6, type: 'circle' },    // right paw (fixed: was 370,520 ‚Äî gap; now ~26px overlap)
                { x: 385, y: 430, points: [[360,420],[390,380],[410,440],[380,480]], answer: 5, type: 'polygon' }  // tail (shifted further left; vertex 360,420 is ~72px from body, ~18px inside r=90)
            ],
            unicorns: [
                { x: 300, y: 80, points: [[300,60],[280,120],[320,120]], answer: 15, type: 'triangle' },   // horn
                { x: 150, y: 120, r: 70, answer: 8, type: 'circle' },    // left ear
                { x: 450, y: 120, r: 70, answer: 8, type: 'circle' },    // right ear
                { x: 300, y: 220, r: 130, answer: 18, type: 'circle' },  // head
                { x: 250, y: 210, r: 30, answer: 6, type: 'circle' },    // left eye
                { x: 350, y: 210, r: 30, answer: 6, type: 'circle' },    // right eye
                { x: 300, y: 280, r: 25, answer: 3, type: 'circle' },    // nose
                { x: 300, y: 420, r: 110, answer: 20, type: 'circle' },  // body
                { x: 248, y: 535, r: 40, answer: 10, type: 'circle' },   // left paw (fixed: was 230,560 ‚Äî gap; now ~24px overlap)
                { x: 352, y: 535, r: 40, answer: 10, type: 'circle' },   // right paw (fixed: was 370,560 ‚Äî gap; now ~24px overlap)
                { x: 415, y: 395, points: [[390,380],[430,340],[450,400],[420,440],[390,420]], answer: 12, type: 'polygon' }  // tail (fixed: shifted left; vertex 390,420 is 90px from body, inside r=110)
            ],
            frogs: [
                { x: 240, y: 140, r: 35, answer: 2, type: 'circle' },   // left eye (~40px overlap with head)
                { x: 360, y: 140, r: 35, answer: 2, type: 'circle' },   // right eye (~40px overlap with head)
                { x: 300, y: 200, r: 90, answer: 4, type: 'circle' },   // head (~45px overlap with body)
                { x: 300, y: 280, r: 30, answer: 6, type: 'circle' },   // throat (40px overlap with head; 65px with body)
                { x: 175, y: 315, r: 45, answer: 3, type: 'circle' },   // left front leg (~24px overlap with body)
                { x: 425, y: 315, r: 45, answer: 3, type: 'circle' },   // right front leg (~24px overlap with body)
                { x: 300, y: 355, r: 110, answer: 8, type: 'circle' },  // body
                { x: 215, y: 448, r: 40, answer: 6, type: 'circle' },   // left back foot (~24px overlap with body)
                { x: 385, y: 448, r: 40, answer: 6, type: 'circle' }    // right back foot (~24px overlap with body)
            ],
            elephants: [
                { x: 155, y: 195, r: 85, answer: 9, type: 'circle' },   // left ear (~39px overlap with head)
                { x: 445, y: 195, r: 85, answer: 3, type: 'circle' },   // right ear (~39px overlap with head)
                { x: 300, y: 210, r: 100, answer: 12, type: 'circle' }, // head (40px overlap with body)
                { x: 240, y: 310, r: 35, answer: 30, type: 'circle' },  // upper trunk (~18px overlap with head; answer=30 min=half-hour)
                { x: 225, y: 355, r: 30, answer: 30, type: 'circle' },  // lower trunk (~18px overlap with upper trunk)
                { x: 300, y: 390, r: 120, answer: 6, type: 'circle' },  // body
                { x: 205, y: 505, r: 50, answer: 6, type: 'circle' },   // left leg (~21px overlap with body)
                { x: 395, y: 505, r: 50, answer: 6, type: 'circle' },   // right leg (~21px overlap with body)
                { x: 415, y: 330, r: 25, answer: 3, type: 'circle' }    // tail (~15px overlap with body)
            ],
            turtles: [
                { x: 300, y: 140, r: 55, answer: 10, type: 'circle' },  // head (30px overlap with neck)
                { x: 300, y: 195, r: 30, answer: 5, type: 'circle' },   // neck (30px overlap with head; 45px with shell)
                { x: 300, y: 310, r: 130, answer: 25, type: 'circle' }, // shell (body)
                { x: 155, y: 260, r: 45, answer: 5, type: 'circle' },   // left front flipper (~22px overlap with shell)
                { x: 445, y: 260, r: 45, answer: 5, type: 'circle' },   // right front flipper (~22px overlap with shell)
                { x: 175, y: 400, r: 40, answer: 1, type: 'circle' },   // left back flipper (~16px overlap with shell)
                { x: 425, y: 400, r: 40, answer: 1, type: 'circle' },   // right back flipper (~16px overlap with shell)
                { x: 300, y: 448, r: 25, answer: 10, type: 'circle' }   // tail (~17px overlap with shell)
            ],
            butterflies: [
                { x: 300, y: 248, r: 28, answer: 6, type: 'circle' },   // head (16px overlap with body)
                { x: 300, y: 300, r: 40, answer: 5, type: 'circle' },   // body (thorax)
                { x: 300, y: 348, r: 28, answer: 8, type: 'circle' },   // abdomen (20px overlap with body; moved from y=355)
                { x: 206, y: 200, points: [[140,70],[290,180],[275,300],[120,230]], answer: 4, type: 'polygon' },   // upper-left wing (vertex 275,300 is 25px from body center, inside r=40)
                { x: 394, y: 200, points: [[310,180],[460,70],[480,230],[325,300]], answer: 4, type: 'polygon' },   // upper-right wing (vertex 325,300 is 25px from body center, inside r=40)
                { x: 197, y: 367, points: [[120,320],[278,305],[195,475]], answer: 3, type: 'triangle' },  // lower-left wing (vertex 278,305 is ~23px from body, ~17px inside r=40)
                { x: 403, y: 367, points: [[322,305],[480,320],[405,475]], answer: 3, type: 'triangle' }   // lower-right wing (vertex 322,305 is ~23px from body, ~17px inside r=40)
            ]
        };

        function updateLessonInfo() {
            const lesson = lessons[currentLesson];
            document.getElementById('lessonTitle').textContent = lesson.title;
            document.getElementById('lessonDescription').textContent = lesson.description;
        }

        // Fisher-Yates shuffle (in-place)
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Build a random bijection from original answer values ‚Üí shuffled answer values.
        // Preserves section groupings (sections that shared an answer still share one),
        // but which answer value each group gets changes every round.
        function shuffleAnswers() {
            const originals = [...new Set(themes[currentLevel].map(s => s.answer))];
            const shuffled = shuffleArray([...originals]);
            answerMap = {};
            originals.forEach((orig, i) => { answerMap[orig] = shuffled[i]; });
        }

        function getMappedAnswer(section) {
            return answerMap[section.answer] ?? section.answer;
        }

        // Bug 2 fix: generate a simple addition fact as fallback instead of showing bare number
        function getRandomProblem(answer) {
            const lesson = lessons[currentLesson];
            const problems = lesson.problems[answer];
            if (problems) return problems[Math.floor(Math.random() * problems.length)];
            const a = Math.floor(answer / 2);
            const b = answer - a;
            return `${a} + ${b} = ?`;
        }

        function renderColorPalette() {
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';

            const answers = [...new Set(themes[currentLevel].map(s => getMappedAnswer(s)))].sort((a, b) => a - b);

            answers.forEach((answer, index) => {
                const option = document.createElement('div');
                option.className = 'color-option';

                const problem = document.createElement('div');
                problem.className = 'math-problem';
                problem.textContent = getRandomProblem(answer);

                const btn = document.createElement('div');
                btn.className = 'color-btn';
                btn.style.backgroundColor = colors[answer] || '#FFB6C1';
                btn.dataset.answer = answer;
                btn.onclick = () => selectColor(answer, btn);

                option.appendChild(problem);
                option.appendChild(btn);
                palette.appendChild(option);
            });
        }

        function selectColor(answer, btn) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedColor = answer;
        }

        // Bug 3 fix: two-pass rendering so outlines never get covered by later fills
        function fillSection(section) {
            ctx.fillStyle = coloredSections.has(section)
                ? (colors[getMappedAnswer(section)] || '#FFB6C1')
                : 'white';
            if (section.type === 'circle') {
                ctx.beginPath();
                ctx.arc(section.x, section.y, section.r, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.beginPath();
                ctx.moveTo(section.points[0][0], section.points[0][1]);
                for (let i = 1; i < section.points.length; i++) {
                    ctx.lineTo(section.points[i][0], section.points[i][1]);
                }
                ctx.closePath();
                ctx.fill();
            }
        }

        function strokeSection(section) {
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#2d3436';
            if (section.type === 'circle') {
                ctx.beginPath();
                ctx.arc(section.x, section.y, section.r, 0, Math.PI * 2);
                ctx.stroke();
            } else {
                ctx.beginPath();
                ctx.moveTo(section.points[0][0], section.points[0][1]);
                for (let i = 1; i < section.points.length; i++) {
                    ctx.lineTo(section.points[i][0], section.points[i][1]);
                }
                ctx.closePath();
                ctx.stroke();
            }
            // Draw number label only if section not yet colored (#2d3436 for WCAG AA contrast)
            if (!coloredSections.has(section)) {
                ctx.fillStyle = '#2d3436';
                ctx.font = 'bold 24px Fredoka';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(getMappedAnswer(section), section.x, section.y);
            }
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const current = themes[currentLevel];
            if (!current) return;
            current.forEach(section => fillSection(section));   // pass 1: all fills
            current.forEach(section => strokeSection(section)); // pass 2: all outlines + labels
            updateProgress();
        }

        function updateProgress() {
            const total = themes[currentLevel].length;
            const colored = coloredSections.size;
            const percent = (colored / total) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function isPointInSection(x, y, section) {
            if (section.type === 'circle') {
                const dx = x - section.x;
                const dy = y - section.y;
                return dx * dx + dy * dy <= section.r * section.r;
            } else if (section.type === 'triangle' || section.type === 'polygon') {
                let inside = false;
                const points = section.points;
                for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
                    const xi = points[i][0], yi = points[i][1];
                    const xj = points[j][0], yj = points[j][1];
                    const intersect = ((yi > y) !== (yj > y))
                        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            }
            return false;
        }

        // Bug 1 fix: flash red overlay for wrong-color clicks
        function drawSectionFlash(section, color) {
            ctx.fillStyle = color;
            if (section.type === 'circle') {
                ctx.beginPath();
                ctx.arc(section.x, section.y, section.r, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.beginPath();
                ctx.moveTo(section.points[0][0], section.points[0][1]);
                for (let i = 1; i < section.points.length; i++) {
                    ctx.lineTo(section.points[i][0], section.points[i][1]);
                }
                ctx.closePath();
                ctx.fill();
            }
        }

        function flashWrongSection(section) {
            drawSectionFlash(section, 'rgba(255, 0, 0, 0.35)');
            setTimeout(() => drawCanvas(), 400);
        }

        // Bug 1 fix: reverse iteration so top-painted (small) shapes are hit-tested first
        function handleCanvasClick(event) {
            if (!selectedColor) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;

            const sections = themes[currentLevel];
            for (let i = sections.length - 1; i >= 0; i--) {
                const section = sections[i];
                if (isPointInSection(x, y, section)) {
                    if (getMappedAnswer(section) === selectedColor) {
                        coloredSections.add(section);
                        drawCanvas();
                        if (coloredSections.size === themes[currentLevel].length) {
                            setTimeout(celebrate, 500);
                        }
                    } else {
                        flashWrongSection(section);
                    }
                    break;
                }
            }
        }

        function handleTouch(event) {
            event.preventDefault();
            const touch = event.touches[0];
            const mouseEvent = new MouseEvent('click', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function celebrate() {
            const celebration = document.getElementById('celebration');
            celebration.classList.add('show');
            for (let i = 0; i < 50; i++) {
                setTimeout(() => createConfetti(), i * 30);
            }
            setTimeout(() => {
                celebration.classList.remove('show');
            }, 3000);
        }

        function hideCelebration() {
            document.getElementById('celebration').classList.remove('show');
        }

        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.top = '-10px';
            confetti.style.backgroundColor = ['#FF6B9D', '#4ECDC4', '#FFE66D', '#A8E6CF', '#C7CEEA'][Math.floor(Math.random() * 5)];
            confetti.style.animation = `fall ${2 + Math.random() * 2}s linear`;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 4000);
        }

        // Bug 4 fix: accept btn parameter instead of relying on implicit global event.target
        function selectLevel(level, btn) {
            currentLevel = level;
            coloredSections.clear();
            shuffleAnswers();
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderColorPalette();
            drawCanvas();
        }

        function resetCanvas() {
            coloredSections.clear();
            shuffleAnswers();
            renderColorPalette();
            drawCanvas();
        }

        // Bug 4 fix: use data-level for reliable active-button detection; includes all 7 levels
        function newPicture() {
            const levels = ['puppies', 'kitties', 'unicorns', 'frogs', 'elephants', 'turtles', 'butterflies'];
            let newLevel;
            do {
                newLevel = levels[Math.floor(Math.random() * levels.length)];
            } while (newLevel === currentLevel && levels.length > 1);
            currentLevel = newLevel;
            coloredSections.clear();
            shuffleAnswers();
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.level === newLevel);
            });
            renderColorPalette();
            drawCanvas();
        }

        function nextLesson() {
            currentLesson = (currentLesson + 1) % lessons.length;
            coloredSections.clear();
            shuffleAnswers();
            updateLessonInfo();
            renderColorPalette();
            drawCanvas();
        }

        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', handleTouch);

        updateLessonInfo();
        shuffleAnswers();
        renderColorPalette();
        drawCanvas();
    </script>
</body>
</html>
